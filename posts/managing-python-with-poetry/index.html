<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Maxim Mozgovoy">
    <meta name="description" content="The Problem Python is a very reasonable &#34;default&#34; language of choice for a variety of tasks. At least on desktop platforms, it makes sense to start with Python and see how it goes. Unfortunately, along its way to popularity it lost much of the simplicity that made it fun in the first place. An especially egregious aspect of Python is its poor backward compatibility. In practice it means that your codebase will only reliably work with a specific version of Python interpreter.">
    <meta name="keywords" content="blog,developer,personal,homepage">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Managing Python with Poetry"/>
<meta name="twitter:description" content="The Problem Python is a very reasonable &#34;default&#34; language of choice for a variety of tasks. At least on desktop platforms, it makes sense to start with Python and see how it goes. Unfortunately, along its way to popularity it lost much of the simplicity that made it fun in the first place. An especially egregious aspect of Python is its poor backward compatibility. In practice it means that your codebase will only reliably work with a specific version of Python interpreter."/>

    <meta property="og:title" content="Managing Python with Poetry" />
<meta property="og:description" content="The Problem Python is a very reasonable &#34;default&#34; language of choice for a variety of tasks. At least on desktop platforms, it makes sense to start with Python and see how it goes. Unfortunately, along its way to popularity it lost much of the simplicity that made it fun in the first place. An especially egregious aspect of Python is its poor backward compatibility. In practice it means that your codebase will only reliably work with a specific version of Python interpreter." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mmozgovoy.dev/posts/managing-python-with-poetry/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-06T14:47:03+09:00" />
<meta property="article:modified_time" content="2021-09-06T14:47:03+09:00" />



    <title>
  Managing Python with Poetry · The Pro Amateur
</title>

    
      <link rel="canonical" href="https://mmozgovoy.dev/posts/managing-python-with-poetry/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css" integrity="sha256-cIaG&#43;KuBdukdRPy&#43;SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="/css/admonitions.css" />
    
      <link rel="stylesheet" href="/css/academicons.min.css" />
    

    

    <link rel="icon" type="image/png" href="/misc/favicon.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.87.0" />
  </head>

  
  
  <body class="preload-transitions colorscheme-light"
        onload=""
  >
    

    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      The Pro Amateur
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/books/">Books</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/papers/">Papers</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/software/">Software</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/cv/">CV</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/zx/">ZX</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://mmozgovoy.dev/posts/managing-python-with-poetry/">
              Managing Python with Poetry
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2021-09-06T14:47:03&#43;09:00'>
                September 6, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              8-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div>
        
        <div class="sect1">
<h2 id="_the_problem">The Problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Python is a very reasonable &#34;default&#34; language of choice for a variety of tasks. At least on desktop platforms, it makes sense to start with Python and see how it goes. Unfortunately, along its way to popularity it <a href="https://xkcd.com/1987/">lost much of the simplicity</a> that <a href="https://xkcd.com/353/">made it fun</a> in the first place. An especially egregious aspect of Python is its poor backward compatibility. In practice it means that your codebase will only reliably work with a specific version of Python interpreter.</p>
</div>
<div class="paragraph">
<p>Even worse, the same holds for many popular libraries. Some Python codebase will only work with a certain library version 5.0.0 or <em>lower</em>, while another codebase requires 5.0.1 or <em>higher</em>. Thus, working with a single combination of Python interpreter and a bunch of libraries is simply not an option beyond the most basic experiments.</p>
</div>
<div class="paragraph">
<p>Working with third-party code is also not straightforward. Python has an official <a href="https://pypi.org">package repository</a>, where any reasonable non-standard library is supposed to be present. Thus, code snippets found online often make no distinction between the standard library and third-party packages. For example, the following snippet will throw an exception on a freshly installed Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span style="color: #008800;font-weight: bold">import</span> <span style="color: #bb0066;font-weight: bold">json</span>
<span style="color: #008800;font-weight: bold">import</span> <span style="color: #bb0066;font-weight: bold">dotmap</span>

<span style="color: #008800;font-weight: bold">print</span><span style="">(</span><span style="color: #dd2200;background-color: #fff0f0">&#34;hello, world&#34;</span><span style="">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem is simple: <code>json</code> is a standard module, while <code>dotmap</code> is not, so it is supposed to be installed in advance. It is easy to install <code>dotmap</code> by typing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>pip install dotmap</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, it simply installs the most recent version of <code>dotmap</code> globally for the current Python interpreter, which might cause issues with other codebases, requiring a certain different version of <code>dotmap</code>.</p>
</div>
<div class="paragraph">
<p>Summing up, there are <em>several separate issues</em> here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We should be able to ensure the right version of Python interpreter for our code.</p>
</li>
<li>
<p>We should be able to ensure the right combination of versions of third-party libraries and their presence in the system.</p>
</li>
<li>
<p>We should be able to isolate different setups from each other.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In other words, the basic problem is to recreate a Python environment, where our system is being developed, on another machine.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_poetry">Using Poetry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The issues described above are well known in Python world, and there are standard or semi-standard tools for dealing with them. However, they typically solve individual aspects of the problem rather than tackling it as a whole. I believe that nearly every Python project needs to deal with the full pack, and <a href="https://python-poetry.org">Poetry</a> comes close to being an &#34;all-purpose&#34; solution.</p>
</div>
<div class="paragraph">
<p>Poetry can be installed via command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code># Bash
curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -

# Windows PowerShell
(Invoke-WebRequest -Uri https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py -UseBasicParsing).Content | python -</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_adding_poetry_to_python_code">Adding Poetry to Python Code</h3>
<div class="paragraph">
<p>As discussed above, it is almost always desirable to make a local Python environment reproducible, so it makes sense to include Poetry configuration into the project from the very start. However, it can also be done any time later. To do it, navigate to the project directory and run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cmd">poetry init</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command simply asks a few questions in an interactive mode and generates a plain text file named <code>pyproject.toml</code>. It can also be created manually without Poetry, but the shell tool ensures that all the required elements are present.</p>
</div>
<div class="paragraph">
<p>The most important sections are <code>[tool.poetry.dependencies]</code> listing both the <em>main</em> project dependencies and the required Python version, and <code>[tool.poetry.dev-dependencies]</code>, responsible for the <em>development</em> dependencies. The command line tool asks about dependencies, but they can be also added any time later.</p>
</div>
<div class="paragraph">
<p>When adding dependencies, it might be important to set <em>constraints</em> to their version numbers. By default, Poetry suggests the most recent version from <a href="https://pypi.org">PyPi</a>, but it is also possible to add a library not listed on PyPi (such as a Git repository or a binary file). Dependency specification syntax is <a href="https://python-poetry.org/docs/dependency-specification/">quite elaborate</a>, and requires understanding of the <a href="https://semver.org">semantic versioning</a> system. I would say that in most cases the default option would work fine.</p>
</div>
<div class="paragraph">
<p>Adding a new main dependency is easy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry add &lt;name1&gt; [... &lt;nameN&gt;]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A development dependency can be added in a similar manner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry add --dev &lt;name1&gt; [... &lt;nameN&gt;]</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#34;Development&#34; dependencies are assumed to be necessary for project development only. In practice it means we can skip their installation by instructing the system to do so.</p>
</div>
<div class="paragraph">
<p>Removing dependencies is done similarly via <code>poetry remove</code> command.</p>
</div>
<div class="paragraph">
<p>One may ask how to find out the list of dependencies for an existing project. Suppose we already have a Python environment with a number of installed libraries, and use it for some of our projects. How do we know which libraries are needed for any given project? Tools like <a href="https://github.com/bndr/pipreqs">pipreqs</a> may help, but they are not 100% reliable, so, in general, some manual work is needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_virtual_environments">Handling Virtual Environments</h3>
<div class="paragraph">
<p>There is one major difference between adding a dependency manually and using <code>poetry add</code>: the command-line tool immediately <em>installs</em> the dependency. Since dependencies are installed into an isolated project-specific Python environment, we have to discuss these environments first.</p>
</div>
<div class="paragraph">
<p>It is important to note that Poetry <em>will not install</em> Python interpreters specified in project requirements. It is expected that the required Python version is already present in the system.</p>
</div>
<div class="paragraph">
<p>Thus, for example, running</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry add dotmap</code></pre>
</div>
</div>
<div class="paragraph">
<p>will fail if Python 3.6 is not installed, while <code>pyproject.toml</code> has a dependency</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>python = &#34;3.6&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling any command that installs/updates/removes project dependencies forces Poetry to modify the isolated <em>virtual environment</em>, associated with the current project. If this environment doesn’t exist yet, it will be created.</p>
</div>
<div class="paragraph">
<p>By default, Poetry uses the Python version found in <code>PATH</code>. However, suppose that we need to use some other Python, present in the system. In this case, we have to trigger the creation of a virtual environment <em>prior</em> to <code>poetry add</code> (or <code>poetry install</code>) calls.</p>
</div>
<div class="paragraph">
<p>The most straightforward way to do it is to run <code>poetry env use</code> with a full path to the required Python version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cmd">poetry env use C:\Python3.6\python.exe</code></pre>
</div>
</div>
<div class="paragraph">
<p>Poetry remembers this setup, and will use Python 3.6 every time we run <code>poetry add</code> and similar commands from the project directory.</p>
</div>
<div class="paragraph">
<p>Technically, a virtual environment is just a directory where all environment-specific settings and libraries are stored. If it breaks for some reason, we can simply delete this directory and call <code>poetry install</code> or <code>poetry env use</code> to recreate it.</p>
</div>
<div class="paragraph">
<p>By default, all virtual environment directories are kept in the user home location. It is also possible to instruct Poetry to create virtual environments right inside the respective projects by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry config virtualenvs.in-project true</code></pre>
</div>
</div>
<div class="paragraph">
<p>I think this setup is actually more convenient. If I want to delete a project, it will delete the corresponding virtual environment as well. The only real downside I see for now is cluttering of the project directory. When I search for a file inside a project, I have to exclude <code>.venv</code> every time, which is annoying.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_dependencies">Installing Dependencies</h3>
<div class="paragraph">
<p>Having a <code>pyproject.toml</code> file inside the project is enough to be able to run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry install [--no-dev]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and get all the necessary dependencies installed inside the corresponding virtual environment. As mentioned above, Poetry will also automatically create the environment if it is not present (alternatively, use <code>poetry env use</code> to choose the right Python version). Thus, this is the minimal working setup for preparing the system for an existing project: navigate to the project directory on the disk and run <code>poetry install</code>. The <code>--no-dev</code> option instructs Poetry to skip development dependencies.</p>
</div>
<div class="paragraph">
<p>Poetry authors recommend to make one extra step, though. When Poetry installs dependencies, it writes down their <em>exact version numbers</em>  into a file called <code>poetry.lock</code>. If we keep it as a part of the project (i.e., add it to version control), Poetry will make sure to install these specific versions during <code>poetry install</code>.</p>
</div>
<div class="paragraph">
<p>Let’s consider an example. Suppose we have a project that depends on the library <code>dotmap</code>. We add it with a command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry add dotmap@1.*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Poetry actually installs <code>dotmap</code> version 1.3.24 (the most recent version at the time of writing) and writes down this information into <code>poetry.lock</code>. Suppose that after some time I pull this project from the repository on another machine without <code>poetry.lock</code>. If I run <code>poetry install</code>, it will install the most recent <code>dotmap</code> version matching the mask <code>1.*</code>. However, if I keep <code>poetry.lock</code> as well, <code>dotmap</code> version 1.3.24 will be installed.</p>
</div>
<div class="paragraph">
<p>So, to prevent possible issues it is recommended to place <code>poetry.lock</code> under version control and update the libraries listed there manually. This is done by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry update [--no-dev]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The effect of this command is equivalent to deleting <code>poetry.lock</code> and running <code>poetry install</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_project_code">Running Project Code</h3>
<div class="paragraph">
<p>The explicit way to run code inside a project-specific virtual environment is to use <code>poetry run</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry run python main.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basically, <code>poetry run</code> executes any given command inside the project’s environment. It is also possible to open a command line shell to work with environment’s tools without having to prefix them with <code>poetry run</code> all the time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>poetry shell</code></pre>
</div>
</div>
<div class="paragraph">
<p>For now, I prefer the &#34;explicit&#34; version. It feels a bit overly verbose to type <code>poetry run python</code> instead of <code>python</code>, but in practice it is all done inside batch files or Visual Studio Code. Also I tend to think that explicit is good in this case.</p>
</div>
</div>
</div>
</div>

      </div>


      <footer>
        


        
        
        <script src="https://utteranc.es/client.js"
    repo= "rg-software/homepage"
    issue-term="pathname"
    
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
      </footer>
    </article>

    
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        ©
        
        2022
         Maxim Mozgovoy 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>


    </main>

    
      
      <script src="/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js" integrity="sha256-A7F3afT5GuNWZ&#43;HyocqMFvUFYlds&#43;Q/zKzF5kmkU2qU="></script>
    

    

    

    

    

    <script data-goatcounter="https://proamateur.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>


    

    

    
  </body>

</html>
